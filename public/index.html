<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¼ì§€ ì‘ì„± ë„ìš°ë¯¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
<div id="app"></div>
<script>
const USERS = [
  {id:'chman99',password:'suck88',name:'ê´€ë¦¬ì',role:'admin'},
  {id:'ì²œë§Œì„',password:'1234',name:'ì²œë§Œì„',role:'user'},
  {id:'ë°•íš¨ìˆ™',password:'5678',name:'ë°•íš¨ìˆ™',role:'user'},
  {id:'ì†¡ì§€ì•ˆ',password:'1111',name:'ì†¡ì§€ì•ˆ',role:'user'}
];

let state = {
  user: null,
  users: JSON.parse(localStorage.getItem('obs_users')) || USERS,
  logs: JSON.parse(localStorage.getItem('obs_logs')) || [],
  loading: false,
  tab: 'logs'
};

const save = () => {
  localStorage.setItem('obs_users', JSON.stringify(state.users));
  localStorage.setItem('obs_logs', JSON.stringify(state.logs));
};

const getGreeting = () => {
  const h = new Date().getHours(), n = state.user.name;
  if(h>=6&&h<12) return `ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”, ${n} ì„ ìƒë‹˜ â˜€ï¸`;
  if(h>=12&&h<18) return `ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”, ${n} ì„ ìƒë‹˜ ğŸ’ª`;
  if(h>=18&&h<22) return `ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•˜ì…¨ì–´ìš”, ${n} ì„ ìƒë‹˜ ğŸŒ™`;
  return `ëŠ¦ì€ ë°¤ ê³ ìƒì´ ë§ìœ¼ì„¸ìš”, ${n} ì„ ìƒë‹˜ ğŸŒœ`;
};

const render = () => {
  const app = document.getElementById('app');
  if(!state.user) {
    app.innerHTML = `
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div class="text-center mb-4">
            <span class="text-4xl">ğŸ“</span>
            <h1 class="text-2xl font-bold mt-2">ì¼ì§€ ì‘ì„± ë„ìš°ë¯¸</h1>
            <p class="text-sm text-gray-500">ê°ì‚¬í•©ë‹ˆë‹¤ ì£¼ê°„í™œë™ì„¼í„°</p>
          </div>
          <div class="text-center mb-6 py-3 bg-gradient-to-r from-indigo-50 via-purple-50 to-indigo-50 rounded-lg border border-indigo-100">
            <p class="text-sm font-medium text-indigo-600">"ê¸°ë¡ì€ ê°„í¸í•˜ê²Œ, ëŒë´„ì€ ì˜¨ì „í•˜ê²Œ."</p>
            <p class="text-xs text-gray-500 mt-1">ì„ ìƒë‹˜ë“¤ì˜ ì†Œì¤‘í•œ ì‰¼ê³¼ ë” ë‚˜ì€ ë‚´ì¼ì„ ì‘ì›í•©ë‹ˆë‹¤.</p>
            <p class="text-xs text-gray-500 mt-1">ğŸ™ í•˜ë£¨ 5íšŒ ì´ë‚´ ì‚¬ìš©ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</p>
            <p class="text-xs text-indigo-400 mt-2">ê°œë°œì: ì²œë§Œì„</p>
          </div>
          <div class="space-y-4">
            <div><label class="block text-sm font-medium mb-1">ì•„ì´ë””</label><input id="loginId" class="w-full px-4 py-3 border rounded-lg"/></div>
            <div><label class="block text-sm font-medium mb-1">ë¹„ë°€ë²ˆí˜¸</label><input id="loginPw" type="password" class="w-full px-4 py-3 border rounded-lg"/></div>
            <p id="loginErr" class="text-red-500 text-sm hidden">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg">ë¡œê·¸ì¸</button>
          </div>
        </div>
      </div>`;
    return;
  }
  if(state.user.role === 'admin') { renderAdmin(); } else { renderUser(); }
};

const renderUser = () => {
  document.getElementById('app').innerHTML = `
    <div class="p-4 max-w-4xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <div class="flex justify-between items-start mb-4 flex-wrap gap-2">
          <div class="flex items-center gap-3"><span class="text-3xl">ğŸ“</span><h1 class="text-xl font-bold">ì¼ì§€ ì‘ì„± ë„ìš°ë¯¸</h1></div>
          <div class="flex items-center gap-2"><span class="text-sm">${getGreeting()}</span><button onclick="logout()" class="px-3 py-1 bg-gray-100 rounded text-sm">ğŸšª</button></div>
        </div>
        <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 via-blue-50 to-indigo-50 rounded-lg border border-indigo-100">
          <p class="text-sm text-gray-700 text-center">ê°ì‚¬í•©ë‹ˆë‹¤ ì„¼í„° ì„ ìƒë‹˜ë“¤ì˜ ì—…ë¬´ë¶€ë‹´ì„ ì¤„ì—¬ë“œë¦¬ê¸° ìœ„í•´ ê°œë°œëœ ì•±ì…ë‹ˆë‹¤.</p>
          <p class="text-xs text-gray-500 text-center mt-2">ğŸ™ ëª¨ë“  ì„ ìƒë‹˜ì´ ì›í™œí•˜ê²Œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆë„ë¡, í•˜ë£¨ 5íšŒ ì´ë‚´ë¡œ ì‚¬ìš©í•´ ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.</p>
          <p class="text-xs text-indigo-500 text-center mt-2">âœ¦ ê°œë°œì: ì²œë§Œì„ âœ¦</p>
        </div>
        <div class="space-y-4">
          <div><label class="block text-sm font-semibold mb-2">í™œë™ë‚´ìš© <span class="font-normal text-gray-500">(ê´€ì°°ë‚´ìš©ê³¼ íŠ¹ì´ì‚¬í•­ì„ ììœ ë¡­ê²Œ ì…ë ¥)</span></label><textarea id="activity" class="w-full px-4 py-3 border rounded-lg h-40" ${state.loading?'disabled':''}></textarea></div>
          <div class="flex items-center gap-2"><input type="checkbox" id="needAction" class="w-5 h-5"><label for="needAction" class="text-sm">ì²˜ë¦¬ì‚¬í•­ í¬í•¨</label></div>
          <button onclick="generate()" class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white font-semibold py-4 rounded-lg" ${state.loading?'disabled':''}>${state.loading?'â³ ì‘ì„± ì¤‘...':'ê´€ì°°ì¼ì§€ ì‘ì„±í•˜ê¸°'}</button>
        </div>
        <div id="result"></div>
      </div>
      <p class="text-center mt-6 text-sm text-gray-600">ğŸ’™ ê°ì‚¬í•©ë‹ˆë‹¤ ì£¼ê°„í™œë™ì„¼í„°</p>
    </div>`;
};

const renderAdmin = () => {
  const logs = state.logs, users = state.users.filter(u=>u.role==='user');
  const si = {mb:(JSON.stringify(logs).length/1024/1024).toFixed(2), pct:Math.min(100,JSON.stringify(logs).length/(5*1024*1024)*100).toFixed(1)};
  document.getElementById('app').innerHTML = `
    <div class="p-4 max-w-6xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
          <div class="flex items-center gap-3"><span class="text-3xl">ğŸ“</span><div><h1 class="text-xl font-bold">ê´€ë¦¬ì í˜ì´ì§€</h1><p class="text-sm text-gray-500">${state.user.name}ë‹˜</p></div></div>
          <button onclick="logout()" class="px-4 py-2 bg-gray-100 rounded-lg">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div class="flex gap-2 mb-6 flex-wrap">
          <button onclick="state.tab='logs';render()" class="px-4 py-2 rounded-lg ${state.tab==='logs'?'bg-indigo-600 text-white':'bg-gray-100'}">ğŸ“‹ ë¡œê·¸</button>
          <button onclick="state.tab='users';render()" class="px-4 py-2 rounded-lg ${state.tab==='users'?'bg-indigo-600 text-white':'bg-gray-100'}">ğŸ‘¥ ì‚¬ìš©ì</button>
        </div>
        ${state.tab==='logs'?`
          <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
            <h2 class="font-bold">ë¡œê·¸ (${logs.length}ê±´)</h2>
            <div class="flex gap-2">
              <button onclick="exportJSON()" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">ğŸ’¾ ë°±ì—…</button>
              <label class="px-3 py-2 bg-purple-600 text-white rounded text-sm cursor-pointer">ğŸ“‚ ë³µì›<input type="file" accept=".json" onchange="uploadJSON(event)" class="hidden"/></label>
            </div>
          </div>
          <div class="bg-indigo-50 p-3 rounded-lg mb-4"><div class="flex justify-between text-sm"><span>ì €ì¥ê³µê°„</span><span>${si.mb}MB/5MB</span></div><div class="mt-2 h-2 bg-indigo-200 rounded-full"><div class="h-full rounded-full ${+si.pct>80?'bg-red-500':'bg-indigo-600'}" style="width:${si.pct}%"></div></div></div>
          <div class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-3">${users.map(u=>`<div class="bg-gray-50 p-3 rounded"><p class="font-medium">${u.name}</p><p class="text-sm text-gray-500">ìš”ì²­: ${logs.filter(l=>l.userId===u.id).length}íšŒ</p></div>`).join('')}</div>
          <div class="space-y-3">${logs.slice(0,20).map(l=>`<div class="bg-gray-50 border rounded-lg p-4"><div class="flex flex-wrap gap-2 text-sm mb-2"><span class="text-indigo-600">${l.date}</span><span class="text-gray-500">${l.time}</span><span class="font-medium">${l.userName}</span></div><div class="space-y-2 text-sm"><div><p class="text-xs text-gray-500">ì…ë ¥</p><p class="bg-white p-2 rounded border mt-1">${l.input}</p></div><div><p class="text-xs text-green-600">ê´€ì°°ì¼ì§€</p><p class="bg-white p-2 rounded border border-green-200 mt-1">${l.observation}</p></div>${l.action?`<div><p class="text-xs text-orange-600">ì²˜ë¦¬ì‚¬í•­</p><p class="bg-white p-2 rounded border border-orange-200 mt-1">${l.action}</p></div>`:''}</div></div>`).join('')}</div>
        `:`
          <div class="bg-gray-50 p-4 rounded-lg mb-4"><h3 class="font-medium mb-3">ìƒˆ ì‚¬ìš©ì</h3><div class="flex flex-wrap gap-2"><input id="newId" placeholder="ì•„ì´ë””" class="px-3 py-2 border rounded flex-1 min-w-20"><input id="newPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="px-3 py-2 border rounded flex-1 min-w-20"><input id="newName" placeholder="ì´ë¦„" class="px-3 py-2 border rounded flex-1 min-w-20"><button onclick="addUser()" class="px-4 py-2 bg-indigo-600 text-white rounded">ì¶”ê°€</button></div></div>
          <div class="space-y-2">${state.users.map(u=>`<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg flex-wrap gap-2"><div><span class="font-medium">${u.name}</span><span class="text-gray-500 text-sm ml-2">(${u.id})</span><span class="text-gray-400 text-sm ml-2">pw:${u.password}</span>${u.role==='admin'?'<span class="ml-2 px-2 bg-indigo-100 text-indigo-700 text-xs rounded">ê´€ë¦¬ì</span>':''}</div>${u.role!=='admin'?`<button onclick="deleteUser('${u.id}')" class="text-red-600 text-sm">ğŸ—‘ï¸ì‚­ì œ</button>`:''}</div>`).join('')}</div>
        `}
      </div>
    </div>`;
};

const login = () => {
  const id=document.getElementById('loginId').value, pw=document.getElementById('loginPw').value;
  const user=state.users.find(u=>u.id===id&&u.password===pw);
  if(user){state.user=user;render();}else{document.getElementById('loginErr').classList.remove('hidden');}
};
const logout = () => { state.user=null; render(); };

const generate = async () => {
  const activity=document.getElementById('activity').value, needAction=document.getElementById('needAction').checked;
  if(!activity) return alert('í™œë™ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  state.loading=true; render();
  try {
    const res = await fetch('/api/generate', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({activity,needAction})});
    const data = await res.json();
    if(data.error){showResult('âš ï¸ '+data.error,'','');state.loading=false;render();return;}
    let obs=data.result||'', act='';
    if(data.result.includes('[ê´€ì°°ì¼ì§€]')&&data.result.includes('[ì²˜ë¦¬ì‚¬í•­]')){
      obs=(data.result.match(/\[ê´€ì°°ì¼ì§€\]\s*([\s\S]*?)\s*\[ì²˜ë¦¬ì‚¬í•­]/)||[])[1]?.trim()||'';
      act=(data.result.match(/\[ì²˜ë¦¬ì‚¬í•­\]\s*([\s\S]*)$/)||[])[1]?.trim()||'';
    }else if(data.result.includes('[ê´€ì°°ì¼ì§€]')){obs=data.result.replace('[ê´€ì°°ì¼ì§€]','').trim();}
    state.logs.unshift({id:Date.now(),date:new Date().toLocaleDateString('ko-KR'),time:new Date().toLocaleTimeString('ko-KR'),userId:state.user.id,userName:state.user.name,input:activity,observation:obs,action:act});
    save(); showResult('',obs,act);
  }catch(e){showResult('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜','','');}
  state.loading=false; render();
};

const showResult = (err,obs,act) => {
  setTimeout(()=>{
    const r=document.getElementById('result'); if(!r)return;
    r.innerHTML = err?`<div class="mt-6 bg-red-50 border-2 border-red-300 rounded-lg p-4 text-red-800">${err}</div>`:
    `<div class="mt-6 space-y-4">
      <div class="bg-white rounded-lg p-4 border-2 border-green-200"><div class="flex justify-between items-center mb-2"><h3 class="font-bold">ê´€ì°°ì¼ì§€</h3><button onclick="copyText(\`${obs.replace(/`/g,"\\`")}\`)" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm">ğŸ“‹ë³µì‚¬</button></div><div class="bg-gray-50 p-3 rounded border">${obs}</div></div>
${act?`<div class="bg-white rounded-lg p-4 border-2 border-orange-200"><div class="flex justify-between items-center mb-2"><h3 class="font-bold">ì²˜ë¦¬ì‚¬í•­</h3><button onclick="copyText(\`${act.replace(/`/g,"\\`")}\`)" class="px-3 py-1 bg-orange-100 text-orange-700 rounded text-sm">ğŸ“‹ë³µì‚¬</button></div><div class="bg-gray-50 p-3 rounded border">${act}</div></div>`:''}
     <div class="flex justify-center pt-4"><button onclick="regenerate()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold">ë‹¤ì‹œ ì‘ì„±í•˜ê¸°</button></div>
    </div>`;
  },100);
};

const copyText = async(t)=>{try{await navigator.clipboard.writeText(t);alert('ë³µì‚¬ì™„ë£Œ!');}catch{alert('ë³µì‚¬ì‹¤íŒ¨');}};
const addUser = ()=>{const id=document.getElementById('newId').value,pw=document.getElementById('newPw').value,name=document.getElementById('newName').value;if(!id||!pw||!name)return alert('ëª¨ë‘ ì…ë ¥');if(state.users.find(u=>u.id===id))return alert('ì¤‘ë³µ');state.users.push({id,password:pw,name,role:'user'});save();render();};
const deleteUser = (id)=>{if(confirm('ì‚­ì œ?')){state.users=state.users.filter(u=>u.id!==id);save();render();}};
const exportJSON = ()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({logs:state.logs},null,2)],{type:'application/json'}));a.download=`ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;a.click();};
let lastActivity = '';
let lastNeedAction = false;

const regenerate = () => {
  if(!lastActivity) return alert('ì´ì „ ì…ë ¥ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
  document.getElementById('activity').value = lastActivity;
  document.getElementById('needAction').checked = lastNeedAction;
  generate();
};
  const uploadJSON = (e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.logs&&confirm(`${d.logs.length}ê±´ ë³µì›?`)){const ids=new Set(state.logs.map(l=>l.id));state.logs=[...d.logs.filter(l=>!ids.has(l.id)),...state.logs].sort((a,b)=>b.id-a.id);save();render();alert('ì™„ë£Œ');}}catch{alert('ì˜¤ë¥˜');}};r.readAsText(f);};

render();
</script>
</body>
</html>
